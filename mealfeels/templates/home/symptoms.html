{% extends 'base.html' %}

{% block header %}
  <h3>{% block title %}Symptom Tracker{% endblock %}</h3>
{% endblock %}

{% block content %}
<div>
  <canvas id="myChart" style="width:100%"></canvas>
</div>
{% endblock %}

{% block footer %}
<script src="https://cdn.jsdelivr.net/npm/hammerjs@^2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@^2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@^3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@^2"></script>

<script>
function multilineLabel(createdAtMillis, string, maxWidth) {
  var createdAtTime = new Date(createdAtMillis).toLocaleTimeString().replace(/(.*)\D\d+/, '$1');
  var words = string.split(" ")

  var width = 0;
  var brokenString = ["(" + createdAtTime + ")", ""];
  for(var i = 0; i < words.length; i++) {
    var word = words[i]

    if (width + word.length + 1 >= maxWidth) {
      brokenString.push(word);
      width = word.length;
    } else {
      brokenString[brokenString.length - 1] += " " + word;
      width += word.length + 1;
    }

  }

  return brokenString;
}

const ctx = document.getElementById('myChart');

var symptoms = JSON.parse('{{ symptoms | tojson | safe }}');

var chartData = {};

for (const [symptomBatch, occurredAt] of symptoms) {
  for (const [symptomName, magnitude] of Object.entries(symptomBatch)) {
    if (!(symptomName in chartData)) {
      chartData[symptomName] = [];
    }

    chartData[symptomName].push({"y": magnitude, "x": occurredAt});
  }
}

var labeledChartData = [];
for (const [symptom, magnitudes] of Object.entries(chartData)) {
  labeledChartData.push({
    label: symptom,
    data: magnitudes,
    borderWidth: 1,
  });
}

var meals = JSON.parse('{{ meals | tojson | safe }}');

var annotations = {};
for (const [index, [meal, createdAtMillis]] of meals.entries()) {
  annotations[index] = {
    type: 'line',
    scaleID: 'x',
    value: createdAtMillis,
    backgroundColor: '#000',
    width: '5',
    borderColor: 'rgba(0,0,0,0.5)',
    borderWidth: 2,
    borderDash: [4, 5],
    label: {
      content: multilineLabel(createdAtMillis, meal, 50),
      display: false,
      color: "#fff",
      position: 'start',
    }
  };
}

new Chart(ctx, {
  type: 'line',
  data: {
    datasets: labeledChartData
  },
  options: {
    scales: {
      x: {
        type: 'time'
      },
      y: {
        suggestedMax: 10,
        beginAtZero: true
      }
    },
    plugins: {
      annotation: {
        annotations: annotations,
        enter({ element }, event) {
            element.label.options.display = true;
            return true; // force update
        },
        leave({ element }, event) {
            element.label.options.display = false;
        }
      },
      zoom: {
        pan: {
          enabled: true,
          mode: 'x',
        },
        zoom: {
          wheel: {
            enabled: true
          },
          pinch: {
            enabled: true
          },
          mode: 'x'
        }
      }
    }
  }
});
</script>
{% endblock %}
